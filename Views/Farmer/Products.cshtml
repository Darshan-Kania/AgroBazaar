@model IEnumerable<AgroBazaar.Models.Entities.Product>

@{
    ViewData["Title"] = "My Products - Farmer Dashboard";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-seedling text-success"></i> My Products</h2>
    <a asp-action="AddProduct" class="btn btn-success">
        <i class="fas fa-plus"></i> Add New Product
    </a>
</div>

@if (Model.Any())
{
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Product Inventory</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Image</th>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th>Unit</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var product in Model)
                                {
                                    <tr id="product-row-@product.Id">
                                        <td>
                                            @if (!string.IsNullOrEmpty(product.ImageUrl))
                                            {
                                                <img src="@product.ImageUrl" alt="@product.Name" class="img-thumbnail" style="width: 50px; height: 50px; object-fit: cover;">
                                            }
                                            else
                                            {
                                                <div class="bg-light d-flex align-items-center justify-content-center" style="width: 50px; height: 50px; border-radius: 4px;">
                                                    <i class="fas fa-image text-muted"></i>
                                                </div>
                                            }
                                        </td>
                                        <td>
                                            <strong>@product.Name</strong>
                                            @if (!string.IsNullOrEmpty(product.Description))
                                            {
                                                <br><small class="text-muted">@(product.Description.Length > 50 ? product.Description.Substring(0, 50) + "..." : product.Description)</small>
                                            }
                                        </td>
                                        <td>@product.Category.Name</td>
                                        <td><strong>â‚¹@product.Price.ToString("N2")</strong></td>
                                        <td>
                                            <span class="badge @(product.QuantityAvailable > 10 ? "bg-success" : product.QuantityAvailable > 0 ? "bg-warning" : "bg-danger")">
                                                @product.QuantityAvailable
                                            </span>
                                        </td>
                                        <td>@product.Unit</td>
                                        <td>
                                            <span class="badge @(product.IsActive ? "bg-success" : "bg-secondary")" id="status-badge-@product.Id">
                                                @(product.IsActive ? "Active" : "Inactive")
                                            </span>
                                        </td>
                                        <td>@product.CreatedAt.ToString("dd/MM/yyyy")</td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <a asp-action="EditProduct" asp-route-id="@product.Id" class="btn btn-sm btn-outline-primary" title="Edit">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <button type="button" class="btn btn-sm btn-outline-warning" onclick="toggleStatus(@product.Id)" title="Toggle Status" id="toggle-btn-@product.Id">
                                                    <i class="fas @(product.IsActive ? "fa-pause" : "fa-play")"></i>
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteProduct(@product.Id)" title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="fas fa-seedling fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">No Products Yet</h4>
                    <p class="text-muted mb-4">Start building your product catalog to reach more customers.</p>
                    <a asp-action="AddProduct" class="btn btn-success">
                        <i class="fas fa-plus"></i> Add Your First Product
                    </a>
                </div>
            </div>
        </div>
    </div>
}

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this product? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete Product</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let productToDelete = 0;

        function deleteProduct(productId) {
            productToDelete = productId;
            $('#deleteModal').modal('show');
        }

        $('#confirmDelete').click(function() {
            if (productToDelete > 0) {
                $.ajax({
                    url: '@Url.Action("DeleteProduct", "Farmer")',
                    type: 'POST',
                    data: {
                        id: productToDelete,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            $('#product-row-' + productToDelete).fadeOut();
                            showAlert('success', response.message);
                        } else {
                            showAlert('danger', response.message);
                        }
                        $('#deleteModal').modal('hide');
                    },
                    error: function() {
                        showAlert('danger', 'An error occurred while deleting the product.');
                        $('#deleteModal').modal('hide');
                    }
                });
            }
        });

        function toggleStatus(productId) {
            $.ajax({
                url: '@Url.Action("ToggleProductStatus", "Farmer")',
                type: 'POST',
                data: {
                    id: productId,
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        const badge = $('#status-badge-' + productId);
                        const toggleBtn = $('#toggle-btn-' + productId + ' i');
                        
                        if (response.isActive) {
                            badge.removeClass('bg-secondary').addClass('bg-success').text('Active');
                            toggleBtn.removeClass('fa-play').addClass('fa-pause');
                        } else {
                            badge.removeClass('bg-success').addClass('bg-secondary').text('Inactive');
                            toggleBtn.removeClass('fa-pause').addClass('fa-play');
                        }
                        
                        showAlert('success', response.message);
                    } else {
                        showAlert('danger', response.message);
                    }
                },
                error: function() {
                    showAlert('danger', 'An error occurred while updating the product status.');
                }
            });
        }

        function showAlert(type, message) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            // Remove existing alerts
            $('.alert').remove();
            
            // Add new alert at the top of the page
            $('h2').after(alertHtml);
            
            // Auto-hide after 5 seconds
            setTimeout(function() {
                $('.alert').fadeOut();
            }, 5000);
        }
    </script>
}
